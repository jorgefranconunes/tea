#!/bin/sh
###########################################################################
#
# Copyright (c) 2001-2008 PDM&FC, All Rights Reserved.
#
###########################################################################

###########################################################################
#
# $Id$
#
#
# Sets up a Tea software installation tree.
#
#
# Revisions:
#
# 2005/01/18 Solved issues with detecting Cygwin. (jfn)
#
# 2004/09/29 The templates files were renamed to better follow current
# naming practices. (jfn)
#
# 2003/02/11 Rewriten to use the new configuration files. (jfn)
#
# 2002/10/28 The "tsh" configuration file is now named "tsh.conf",
# instead of "tsh.config". (jfn)
#
# 2001/05/12 Created. (jfn)
#
###########################################################################

SCRIPT_DIR=`dirname $0`
SCRIPT_NAME=`basename $0`

teaBaseDir=`cd $SCRIPT_DIR/..; pwd`
pathSep=":"





###########################################################################
#
# 
#
###########################################################################

#
# Makes utility functions available.
#
. ${teaBaseDir}/bin/tea-utils

case `teaOsType` in
    *CYGWIN* )
	pathSep=";"
	teaBaseDir=`cygpath --windows "$teaBaseDir" | sed 's/\\\/\\//g'`
    ;;
esac

teaReadCoreConfig $teaBaseDir

TEA_JRE=
TEA_CORE_CLASSPATH=
TEA_CORE_LIBRARY=
verbose=1
teaInstallConfigFile=${teaBaseDir}/config/tea-install.conf
teaInstallConfigTemplate=${teaInstallConfigFile}.template
otherClasspath=





###########################################################################
#
# 
#
###########################################################################

displayHeader () {

    cat <<EOF

Setup Tool for the Tea $TEA_VERSION Instalation
Copyright (c) 2001, 2002, 2003, 2004, 2005 PDM&FC, All Rights Reserved.

EOF
}





###########################################################################
#
# Displays an help message describing the configuration options.
#
###########################################################################

displayHelp () {

    displayHeader

    cat <<EOF
Configures your Tea instalation at $teaBaseDir

Available options:
--java-home=PATH
	Base directory of your Java instalation. PATH is supposed to be a
	directory containing a "bin" directory with a "java" executable.
	This option is not mandatory if the --jre option has been
	specified.
--jre=PATH
	Path to your Java runtime environment executable. It must accept
	the "-classpath" and "-D" options. This option is not mandatory
	if the --java-home option has been specified.
--classpath=DIRLIST
	Colon separated directory and JAR list. These are added to the
	classpath of the JVM running the Tea interpreter launched by
	the "tsh" utility. This is only required when Java extensions
	to the Tea runtime are used.
EOF
}





###########################################################################
#
# 
#
###########################################################################

for option in "$@"
  do
  case $option in
      --java-home=* )
	  javaHome=`expr "$option" : '--java-home=\(.*\)'`
	  TEA_JRE=${javaHome}/bin/java
	  ;;
      --jre=* )
	  TEA_JRE=`expr "$option" : '--jre=\(.*\)'`
	  ;;
      --classpath=* )
	  otherClasspath=`expr "$option" : '--classpath=\(.*\)'`
	  ;;
      --quiet )
	  verbose=0
	  ;;
      --help )
	  displayHelp
	  exit 0
	  ;;
      --*=* )
	  option=`expr $option : '\(--.*\)=.*'`
	  teaError "$option : unrecognized option. Use --help to see options."
	  ;;
      * )
	  teaError "$option : unrecognized option. Use --help to see options."
	  exit 1
	  ;;
  esac
done

if [ -z "$TEA_JRE" ]
    then
    teaError "Missing --jre or --java-home option. Use --help for details."
fi

TEA_CORE_LIBRARY="."

#
# Builds the full core classpath.
#
TEA_CORE_CLASSPATH="$otherClasspath"

for jarBasename in $TEA_CORE_JARS
  do
  jarFile=${teaBaseDir}/lib/$jarBasename
  TEA_CORE_CLASSPATH="$TEA_CORE_CLASSPATH${pathSep}$jarFile"
done





###########################################################################
#
# Display the parameters.
#
###########################################################################

if [ $verbose -eq 1 ]
then
    displayHeader

    cat <<EOF
Tea runtime environment configured with the following options:

Java runtime
	$TEA_JRE
EOF

    echo "Java libraries"
    for path in `echo $TEA_CORE_CLASSPATH | sed "s/$pathSep/ /g"`
    do
	echo "	$path"
    done

    echo "Tea libraries"
    for path in `echo $TEA_CORE_LIBRARY | sed "s/$pathSep/ /g"`
    do
	echo "	$path"
    done
    echo
fi





###########################################################################
#
# Creates the installation configuration file.
#
###########################################################################

teaParseTemplate $teaInstallConfigTemplate > $teaInstallConfigFile





#########################################################################
#
# 
#
#########################################################################

