#!/bin/bash
###########################################################################
#
# Copyright (c) 2001-2010 PDM&FC, All Rights Reserved.
#
###########################################################################

###########################################################################
#
# $Id$
#
#
# Sets up a Tea software installation tree.
#
#
# Revisions:
#
# 2008/08/29 Refactored such that is now structured. (jfn)
#
# 2005/01/18 Solved issues with detecting Cygwin. (jfn)
#
# 2004/09/29 The templates files were renamed to better follow current
# naming practices. (jfn)
#
# 2003/02/11 Rewriten to use the new configuration files. (jfn)
#
# 2002/10/28 The "tsh" configuration file is now named "tsh.conf",
# instead of "tsh.config". (jfn)
#
# 2001/05/12 Created. (jfn)
#
###########################################################################

_scriptDir=$(dirname $0)
_scriptName=$(basename $0)

_teaBaseDir=$(cd $_scriptDir/..; pwd)





###########################################################################
#
# 
#
###########################################################################

#
# Makes utility functions available.
#
source ${_teaBaseDir}/bin/tea-utils

case $(teaOsType) in
    *CYGWIN* )
	_teaBaseDir=$(cygpath --windows "$_teaBaseDir" | sed 's/\\\/\\//g')
    ;;
esac

teaReadCoreConfig $_teaBaseDir

_teaJre=
_teaCoreClasspath=
_teaCoreLibrary="."
_verbose=1
_otherClasspath=
_pathSep=$(teaPathSeparator)

_teaCoreJars=$TEA_CORE_JARS





###########################################################################
#
# 
#
###########################################################################

displayHeader () {

    cat <<EOF

Setup Tool for the Tea $TEA_VERSION Instalation
Copyright (c) 2001-2010 PDM&FC, All Rights Reserved.

EOF
}





###########################################################################
#
# Displays an help message describing the configuration options.
#
###########################################################################

displayHelp () {

    displayHeader

    cat <<EOF
Configures your Tea instalation at $_teaBaseDir

Available options:
--java-home=PATH
	Base directory of your Java instalation. PATH is supposed to be a
	directory containing a "bin" directory with a "java" executable.
	This option is not mandatory if the --jre option has been
	specified.
--jre=PATH
	Path to your Java runtime environment executable. It must
	accept the "-classpath" option. This option is not mandatory
	if the --java-home option has been specified.
--classpath=DIRLIST
	Colon separated directory and JAR list. These are added to the
	classpath of the JVM running the Tea interpreter launched by
	the "tsh" utility. This is only required when Java extensions
	to the Tea runtime are used.
EOF
}





###########################################################################
#
# 
#
###########################################################################

parseCliOptions () {

    for option in "$@" ; do
	case $option in
	    --java-home=* )
		local javaHome=$(expr "$option" : '--java-home=\(.*\)')
		_teaJre=${javaHome}/bin/java
		;;
	    --jre=* )
		_teaJre=$(expr "$option" : '--jre=\(.*\)')
		;;
	    --classpath=* )
		_otherClasspath=$(expr "$option" : '--classpath=\(.*\)')
		;;
	    --quiet )
		_verbose=0
		;;
	    --help )
		displayHelp
		exit 0
		;;
	    --*=* )
		option=$(expr $option : '\(--.*\)=.*')
		teaError "$option : unrecognized option. Use --help to see options."
		;;
	    * )
		teaError "$option : unrecognized option. Use --help to see options."
		exit 1
		;;
	esac
    done

    if [ -z "$_teaJre" ] ; then
	teaError "Missing --jre or --java-home option. Use --help for details."
    fi

    #
    # Builds the full core classpath.
    #
    _teaCoreClasspath="$_otherClasspath"

    for jarBasename in $_teaCoreJars ; do
	local jarFile=${_teaBaseDir}/lib/jars/$jarBasename

	if [ -z "$_teaCoreClasspath" ] ; then
	    _teaCoreClasspath=$jarFile
	else
	    _teaCoreClasspath="$_teaCoreClasspath${_pathSep}$jarFile"
	fi
    done
}





###########################################################################
#
# Display the parameters.
#
###########################################################################

displayParameters () {

    if [ $_verbose -eq 1 ] ; then
	displayHeader

	cat <<EOF
Tea runtime environment configured with the following options:

Java runtime
	$_teaJre
EOF

	echo "Java libraries"
	for path in $(echo $_teaCoreClasspath | sed "s/$_pathSep/ /g") ; do
	    echo "	$path"
	done

	echo "Tea libraries"
	for path in $(echo $_teaCoreLibrary | sed "s/$_pathSep/ /g") ; do
	    echo "	$path"
	done
	echo
    fi
}





###########################################################################
#
# Creates the installation configuration file.
#
###########################################################################

createInstallConfig () {

    local installConfigFile=${_teaBaseDir}/config/tea-install.conf
    local installConfigTemplate=${installConfigFile}.template

    TEA_JRE=$_teaJre
    TEA_CORE_LIBRARY=$_teaCoreLibrary
    TEA_CORE_CLASSPATH=$_teaCoreClasspath

    teaParseTemplate $installConfigTemplate > $installConfigFile
}





#########################################################################
#
# The main script.
#
#########################################################################

parseCliOptions "$@"
displayParameters
createInstallConfig





#########################################################################
#
# 
#
#########################################################################

