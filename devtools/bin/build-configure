#!/bin/bash
###########################################################################
#
# Copyright (c) 2008-2010 PDM&FC, All Rights Reserved.
#
#
# Configures the development tree for performing builds.
#
###########################################################################

_scriptDir=$(dirname $0)
_scriptName=$(basename $0)

_teaBaseDir=$(cd $_scriptDir/../..; pwd)

#
# Makes utility functions available.
#
source ${_teaBaseDir}/bin/tea-utils





#
# The following will have to be adapted whenever a new version of
# theses packages is used.
#
CONF_ANT_BUNDLE=${_teaBaseDir}/third-party/apache-ant-1.8.0-bin.tar.bz2
CONF_ANT_HOME=${_teaBaseDir}/devtools/apache-ant-1.8.0
CONF_ANT_TOOL=${CONF_ANT_HOME}/bin/ant

CONF_ANTC_BUNDLE=${_teaBaseDir}/third-party/ant-contrib-1.0b3-bin.zip
CONF_ANTC_JAR=ant-contrib/ant-contrib-1.0b3.jar

CONF_JUNIT_BUNDLE=${_teaBaseDir}/third-party/junit4.8.2.zip
CONF_JUNIT_JAR=junit4.8.2/junit-4.8.2.jar





###########################################################################
#
# 
#
###########################################################################

function readBuildConfig () {

    local buildConf=${_teaBaseDir}/build.conf

    if [ ! -f $buildConf ] ; then
	teaError "Build config file \"$buildConf\" is missing."
    fi

    source $buildConf

    local requiredParams="
        BUILD_JAVA_HOME
"

    for paramName in $requiredParams ; do
	local paramValue=${!paramName}

	if [ -z "$paramValue" ] ; then
	    teaError "Parameter \"$paramName\" not defined on \"$buildConf\""
	fi
    done

    # Assign values to aditional config parameters.
    source ${_teaBaseDir}/config/tea-core.conf

    BUILD_BASE_DIR=$_teaBaseDir
    BUILD_VERSION=$TEA_VERSION
}





###########################################################################
#
# 
#
###########################################################################

function createMakefileConfig () {

    local templateFile=${_teaBaseDir}/config/Makefile.conf.template
    local resultFile=${_teaBaseDir}/Makefile.conf

    teaParseTemplate $templateFile > $resultFile
}





###########################################################################
#
# Installs Ant if BUILD_ANT is not defined on "build.conf"
#
###########################################################################

function antSetup () {

    if [ "$BUILD_ANT" == "" ] ; then
        if [ ! -x $CONF_ANT_TOOL ] ; then
            local devtoolsDir=$(dirname ${CONF_ANT_HOME})

            mkdir -p $devtoolsDir

            (cd $devtoolsDir ; tar xfj $CONF_ANT_BUNDLE)
        fi

        BUILD_ANT=$CONF_ANT_TOOL
    fi

    local antcJarDir=${_teaBaseDir}/devtools/lib/jars
    local antcJarPath=${antcJarDir}/${CONF_JUNIT_JAR}

    if [ ! -f $antcJarPath ] ; then
        mkdir -p $antcJarDir
        unzip -q -o -j $CONF_ANTC_BUNDLE $CONF_ANTC_JAR -d $antcJarDir
    fi
}





###########################################################################
#
# 
#
###########################################################################

function junitSetup () {

    local jarDir=${_teaBaseDir}/devtools/lib/jars

    mkdir -p $jarDir
    unzip -q -o -j $CONF_JUNIT_BUNDLE $CONF_JUNIT_JAR -d $jarDir
}





###########################################################################
#
# The main script.
#
###########################################################################

readBuildConfig
antSetup
junitSetup
createMakefileConfig





###########################################################################
#
# 
#
###########################################################################

