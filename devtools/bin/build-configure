#!/bin/bash
###########################################################################
#
# Copyright (c) 2008-2010 PDM&FC, All Rights Reserved.
#
#
# Configures the Tea development tree for performing builds.
#
###########################################################################

_scriptDir=$(dirname $0)
_scriptName=$(basename $0)
_teaBaseDir=$(cd $_scriptDir/../..; pwd)

#
# Makes utility functions available.
#
source ${_teaBaseDir}/bin/tea-utils





#
# The following will have to be adapted whenever a new version of
# theses packages is used.
#
CONF_ANT_BUNDLE=${_teaBaseDir}/third-party/apache-ant-1.8.0-bin.tar.bz2
CONF_ANT_HOME=${_teaBaseDir}/devtools/apache-ant-1.8.0
CONF_ANT_TOOL=${CONF_ANT_HOME}/bin/ant





###########################################################################
#
# 
#
###########################################################################

function readMakefileConfig () {

    local buildConf=${_teaBaseDir}/Makefile.conf

    if [ ! -f $buildConf ] ; then
	teaError "Build config file \"$buildConf\" is missing."
    fi

    source $buildConf

    local requiredParams="
        BUILD_JAVA_HOME
"

    for paramName in $requiredParams ; do
	local paramValue=${!paramName}

	if [ -z "$paramValue" ] ; then
	    teaError "Parameter \"$paramName\" not defined on \"$buildConf\""
	fi
    done

    # Assign values to aditional config parameters.
    source ${_teaBaseDir}/config/tea-core.conf

    BUILD_BASE_DIR=${_teaBaseDir}
    BUILD_VERSION=${TEA_VERSION}
}





###########################################################################
#
# Installs Ant if BUILD_ANT is not defined on "build.conf"
#
###########################################################################

function antSetup () {

    if [ -z "$BUILD_ANT" ] ; then
        if [ ! -x $CONF_ANT_TOOL ] ; then
            local devtoolsDir=$(dirname ${CONF_ANT_HOME})

            mkdir -p $devtoolsDir

            (cd $devtoolsDir ; tar xfj $CONF_ANT_BUNDLE)
        fi

        BUILD_ANT=$CONF_ANT_TOOL
    fi

}





###########################################################################
#
# The main script.
#
###########################################################################

readMakefileConfig
antSetup





###########################################################################
#
# 
#
###########################################################################

